name: Release & Update Index
on:
  push:
    tags: ['v*']
permissions:
  contents: write
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create zip
        run: zip -r napcat-plugin-brushing.zip index.mjs package.json
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            napcat-plugin-brushing.zip
            index.mjs
            package.json
      - name: Update Plugin Index
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            const version = '${{ github.ref_name }}';
            const downloadUrl = `https://github.com/${{ github.repository }}/releases/download/${version}/${pkg.name}.zip`;
            
            const indexOwner = 'NapNeko';
            const indexRepo = 'napcat-plugin-index';
            const myOwner = context.repo.owner;
            
            try { await github.rest.repos.createFork({ owner: indexOwner, repo: indexRepo }); await new Promise(r => setTimeout(r, 5000)); } catch {}
            
            const { data: file } = await github.rest.repos.getContent({ owner: myOwner, repo: indexRepo, path: 'plugins.v4.json' });
            const index = JSON.parse(Buffer.from(file.content, 'base64').toString());
            
            const pluginData = {
              id: pkg.name,
              name: pkg.plugin,
              version: version,
              description: pkg.description,
              author: pkg.author,
              homepage: pkg.napcat?.homepage || `https://github.com/${context.repo.owner}/${context.repo.repo}`,
              downloadUrl: downloadUrl,
              tags: pkg.napcat?.tags || ['å·¥å…·'],
              minVersion: pkg.napcat?.minVersion || '4.14.0'
            };
            
            const idx = index.plugins.findIndex(p => p.id === pkg.name);
            if (idx >= 0) index.plugins[idx] = pluginData;
            else index.plugins.push(pluginData);
            index.updateTime = new Date().toISOString();
            
            const action = idx >= 0 ? 'æ›´æ–°è‡³' : 'æ–°å¢ž';
            await github.rest.repos.createOrUpdateFileContents({
              owner: myOwner, repo: indexRepo, path: 'plugins.v4.json',
              message: `ðŸ”Œ [${pkg.plugin}] ${action} ${version}`,
              content: Buffer.from(JSON.stringify(index, null, 2)).toString('base64'),
              sha: file.sha
            });
            
            await github.rest.pulls.create({
              owner: indexOwner, repo: indexRepo,
              title: `ðŸ”Œ [${pkg.plugin}] ${action} ${version}`,
              body: `## ðŸ¤– è‡ªåŠ¨æ›´æ–°æ’ä»¶ç´¢å¼•\n\n| å­—æ®µ | å€¼ |\n|------|-----|\n| **æ’ä»¶ ID** | \`${pkg.name}\` |\n| **æ’ä»¶åç§°** | ${pkg.plugin} |\n| **ç‰ˆæœ¬** | ${version} |\n| **ä½œè€…** | ${pkg.author} |\n| **ä¸‹è½½é“¾æŽ¥** | ${downloadUrl} |\n\n> æ­¤ PR ç”± CI è‡ªåŠ¨åˆ›å»º`,
              head: `${myOwner}:main`, base: 'main'
            });
