name: Release & Update Index

on:
  push:
    tags: ['v*']

permissions:
  contents: write

env:
  INDEX_REPO: NapNeko/napcat-plugin-index
  INDEX_REPO_NAME: napcat-plugin-index

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Create zip
        run: zip -r napcat-plugin-brushing.zip index.mjs package.json
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            napcat-plugin-brushing.zip
            index.mjs
            package.json

      - name: Extract metadata
        id: meta
        run: |
          PLUGIN_ID=$(node -e "console.log(require('./package.json').name)")
          PLUGIN_NAME=$(node -e "console.log(require('./package.json').plugin)")
          VERSION=$(echo "${{ github.ref_name }}" | sed 's/^v//')
          DESCRIPTION=$(node -e "console.log(require('./package.json').description || '')")
          AUTHOR=$(node -e "console.log(require('./package.json').author || '')")
          TAGS=$(node -e "console.log(JSON.stringify(require('./package.json').napcat?.tags || ['工具']))")
          MIN_VERSION=$(node -e "console.log(require('./package.json').napcat?.minVersion || '4.14.0')")
          HOMEPAGE=$(node -e "console.log(require('./package.json').napcat?.homepage || '')")
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${PLUGIN_ID}.zip"
          
          echo "plugin_id=$PLUGIN_ID" >> $GITHUB_OUTPUT
          echo "plugin_name=$PLUGIN_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "homepage=$HOMEPAGE" >> $GITHUB_OUTPUT
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "min_version=$MIN_VERSION" >> $GITHUB_OUTPUT

      - name: Setup fork
        id: fork
        env:
          GH_TOKEN: ${{ secrets.INDEX_PAT }}
        run: |
          PAT_USER=$(curl -sS -H "Authorization: token ${GH_TOKEN}" https://api.github.com/user | jq -r '.login')
          echo "pat_user=$PAT_USER" >> $GITHUB_OUTPUT
          echo "fork_repo=${PAT_USER}/${{ env.INDEX_REPO_NAME }}" >> $GITHUB_OUTPUT
          
          HTTP_CODE=$(curl -sS -o /dev/null -w "%{http_code}" -H "Authorization: token ${GH_TOKEN}" "https://api.github.com/repos/${PAT_USER}/${{ env.INDEX_REPO_NAME }}")
          if [ "$HTTP_CODE" != "200" ]; then
            curl -sS -X POST -H "Authorization: token ${GH_TOKEN}" "https://api.github.com/repos/${{ env.INDEX_REPO }}/forks" -d '{"default_branch_only": true}'
            sleep 10
          fi
          curl -sS -X POST -H "Authorization: token ${GH_TOKEN}" "https://api.github.com/repos/${PAT_USER}/${{ env.INDEX_REPO_NAME }}/merge-upstream" -d '{"branch": "main"}'

      - uses: actions/checkout@v4
        with:
          repository: ${{ env.INDEX_REPO }}
          ref: main
          path: plugin-index
          token: ${{ secrets.INDEX_PAT }}

      - name: Update index
        env:
          PLUGIN_ID: ${{ steps.meta.outputs.plugin_id }}
          PLUGIN_NAME: ${{ steps.meta.outputs.plugin_name }}
          PLUGIN_VERSION: ${{ steps.meta.outputs.version }}
          PLUGIN_DESCRIPTION: ${{ steps.meta.outputs.description }}
          PLUGIN_AUTHOR: ${{ steps.meta.outputs.author }}
          PLUGIN_HOMEPAGE: ${{ steps.meta.outputs.homepage }}
          PLUGIN_DOWNLOAD_URL: ${{ steps.meta.outputs.download_url }}
          PLUGIN_TAGS: ${{ steps.meta.outputs.tags }}
          PLUGIN_MIN_VERSION: ${{ steps.meta.outputs.min_version }}
        run: |
          cd plugin-index
          node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('plugins.v4.json', 'utf-8'));
            const newPlugin = {
              id: process.env.PLUGIN_ID,
              name: process.env.PLUGIN_NAME,
              version: process.env.PLUGIN_VERSION,
              description: process.env.PLUGIN_DESCRIPTION,
              author: process.env.PLUGIN_AUTHOR,
              homepage: process.env.PLUGIN_HOMEPAGE,
              downloadUrl: process.env.PLUGIN_DOWNLOAD_URL,
              tags: JSON.parse(process.env.PLUGIN_TAGS),
              minVersion: process.env.PLUGIN_MIN_VERSION
            };
            const idx = data.plugins.findIndex(p => p.id === newPlugin.id);
            if (idx >= 0) data.plugins[idx] = newPlugin;
            else data.plugins.push(newPlugin);
            fs.writeFileSync('plugins.v4.json', JSON.stringify(data, null, 2) + '\n');
          "

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          path: plugin-index
          token: ${{ secrets.INDEX_PAT }}
          push-to-fork: ${{ steps.fork.outputs.fork_repo }}
          commit-message: "chore: update ${{ steps.meta.outputs.plugin_id }} to v${{ steps.meta.outputs.version }}"
          branch: "auto-update/${{ steps.meta.outputs.plugin_id }}-v${{ steps.meta.outputs.version }}"
          delete-branch: true
          title: "🔌 [${{ steps.meta.outputs.plugin_name }}] 更新至 v${{ steps.meta.outputs.version }}"
          body: |
            ## 🤖 自动更新插件索引

            | 字段 | 值 |
            |------|-----|
            | **插件 ID** | `${{ steps.meta.outputs.plugin_id }}` |
            | **插件名称** | ${{ steps.meta.outputs.plugin_name }} |
            | **版本** | v${{ steps.meta.outputs.version }} |
            | **作者** | ${{ steps.meta.outputs.author }} |
            | **下载链接** | ${{ steps.meta.outputs.download_url }} |

            > 此 PR 由 CI 自动创建
