name: è‡ªåŠ¨æ›´æ–°æ’ä»¶ç´¢å¼•

on:
  release:
    types: [published]

jobs:
  update-index:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: è¯»å–æ’ä»¶ä¿¡æ¯
        id: plugin
        run: |
          echo "id=$(jq -r '.name' package.json)" >> $GITHUB_OUTPUT
          echo "name=$(jq -r '.plugin' package.json)" >> $GITHUB_OUTPUT
          echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          echo "description=$(jq -r '.description' package.json)" >> $GITHUB_OUTPUT
          echo "author=$(jq -r '.author' package.json)" >> $GITHUB_OUTPUT
          echo "homepage=$(jq -r '.napcat.homepage' package.json)" >> $GITHUB_OUTPUT
          echo "minVersion=$(jq -r '.napcat.minVersion' package.json)" >> $GITHUB_OUTPUT
          TAGS=$(jq -c '.napcat.tags' package.json)
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: Fork å¹¶æ›´æ–°ç´¢å¼•
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const pluginId = '${{ steps.plugin.outputs.id }}';
            const pluginName = '${{ steps.plugin.outputs.name }}';
            const version = '${{ steps.plugin.outputs.version }}';
            const description = '${{ steps.plugin.outputs.description }}';
            const author = '${{ steps.plugin.outputs.author }}';
            const homepage = '${{ steps.plugin.outputs.homepage }}';
            const minVersion = '${{ steps.plugin.outputs.minVersion }}';
            const tags = ${{ steps.plugin.outputs.tags }};
            const downloadUrl = `https://github.com/${{ github.repository }}/releases/download/${version}/${pluginId}.zip`;

            // Fork ç´¢å¼•ä»“åº“
            const indexOwner = 'NapNeko';
            const indexRepo = 'napcat-plugin-index';
            
            try {
              await github.rest.repos.createFork({
                owner: indexOwner,
                repo: indexRepo
              });
              await new Promise(r => setTimeout(r, 5000));
            } catch (e) {}

            // èŽ·å–åŽŸå§‹æ–‡ä»¶
            const { data: file } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: indexRepo,
              path: 'plugins.v4.json'
            });
            
            const content = Buffer.from(file.content, 'base64').toString();
            const index = JSON.parse(content);
            
            // æ›´æ–°æˆ–æ·»åŠ æ’ä»¶
            const existing = index.plugins.findIndex(p => p.id === pluginId);
            const pluginData = {
              id: pluginId,
              name: pluginName,
              version: version,
              description: description,
              author: author,
              homepage: homepage,
              downloadUrl: downloadUrl,
              tags: tags,
              minVersion: minVersion
            };
            
            if (existing >= 0) {
              index.plugins[existing] = pluginData;
            } else {
              index.plugins.push(pluginData);
            }
            
            index.updateTime = new Date().toISOString();
            
            // æ›´æ–° fork ä»“åº“
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: indexRepo,
              path: 'plugins.v4.json',
              message: `ðŸ”Œ [${pluginName}] ${existing >= 0 ? 'æ›´æ–°è‡³' : 'æ–°å¢ž'} ${version}`,
              content: Buffer.from(JSON.stringify(index, null, 2)).toString('base64'),
              sha: file.sha
            });
            
            // åˆ›å»º PR
            const prBody = `## ðŸ¤– è‡ªåŠ¨æ›´æ–°æ’ä»¶ç´¢å¼•\n\n| å­—æ®µ | å€¼ |\n|------|-----|\n| **æ’ä»¶ ID** | \`${pluginId}\` |\n| **æ’ä»¶åç§°** | ${pluginName} |\n| **ç‰ˆæœ¬** | ${version} |\n| **ä½œè€…** | ${author} |\n| **ä¸‹è½½é“¾æŽ¥** | ${downloadUrl} |\n\n> æ­¤ PR ç”± CI è‡ªåŠ¨åˆ›å»º`;
            
            await github.rest.pulls.create({
              owner: indexOwner,
              repo: indexRepo,
              title: `ðŸ”Œ [${pluginName}] ${existing >= 0 ? 'æ›´æ–°è‡³' : 'æ–°å¢ž'} ${version}`,
              body: prBody,
              head: `${context.repo.owner}:main`,
              base: 'main'
            });
